<!DOCTYPE html>
<html>
<head>
  <title>Final Diagnostic</title>
  <link rel="stylesheet" href="https://cdn.nav.no/@navikt/ds-css/5.18.3/darkside.min.css">
  <style>
    body { padding: 2rem; font-family: sans-serif; max-width: 1400px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .section { border: 2px solid #ccc; padding: 1rem; }
    h2 { margin-top: 0; }
    .output { font-family: monospace; font-size: 12px; white-space: pre-wrap; background: #f5f5f5; padding: 1rem; max-height: 400px; overflow-y: auto; }
    .pass { color: green; }
    .fail { color: red; }
    #preview { width: 100%; height: 300px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>üîç Final Diagnostic - What's Wrong?</h1>
  
  <div class="grid">
    <div class="section">
      <h2>Test 1: Direct Render (No Sandbox)</h2>
      <div id="direct-render"></div>
      <div class="output" id="direct-output"></div>
    </div>
    
    <div class="section">
      <h2>Test 2: Via Sandbox Iframe</h2>
      <iframe id="preview" src="/sandbox.html"></iframe>
      <div class="output" id="sandbox-output"></div>
    </div>
  </div>

  <script type="module">
    import React from 'https://esm.sh/react@18.3.1';
    import ReactDOM from 'https://esm.sh/react-dom@18.3.1/client';
    
    const directOutput = document.getElementById('direct-output');
    const sandboxOutput = document.getElementById('sandbox-output');
    const preview = document.getElementById('preview');
    
    function logDirect(msg) {
      directOutput.textContent += msg + '\n';
    }
    
    function logSandbox(msg) {
      sandboxOutput.textContent += msg + '\n';
    }

    // Test 1: Direct render
    async function testDirect() {
      try {
        logDirect('Loading Aksel...');
        const Aksel = await import('https://esm.sh/@navikt/ds-react@5.18.3');
        
        logDirect(`‚úÖ Aksel loaded: ${Object.keys(Aksel).length} exports`);
        
        const { Button, Theme } = Aksel;
        
        if (!Theme) {
          logDirect('‚ùå Theme NOT found in package!');
          logDirect('Searching for theme-related exports...');
          const themeKeys = Object.keys(Aksel).filter(k => k.toLowerCase().includes('theme'));
          logDirect(`Found: ${themeKeys.join(', ') || 'none'}`);
          return;
        }
        
        logDirect('‚úÖ Theme found');
        logDirect(`Theme type: ${typeof Theme}`);
        
        const root = ReactDOM.createRoot(document.getElementById('direct-render'));
        
        logDirect('Rendering with Theme...');
        root.render(
          React.createElement(Theme, null,
            React.createElement('div', { style: { padding: '1rem' } },
              React.createElement(Button, { variant: 'primary' }, 'Direct Render Button')
            )
          )
        );
        
        logDirect('‚úÖ Render complete!');
        
        // Check DOM after render
        setTimeout(() => {
          const btn = document.querySelector('#direct-render button');
          if (btn) {
            logDirect(`Button class: ${btn.className}`);
            logDirect(`Has navds-button: ${btn.classList.contains('navds-button')}`);
          }
        }, 500);
        
      } catch (err) {
        logDirect(`‚ùå Error: ${err.message}`);
        logDirect(err.stack);
      }
    }

    // Test 2: Sandbox
    window.addEventListener('message', (e) => {
      if (e.source !== preview.contentWindow) return;
      if (!e.data?.type) return;
      
      logSandbox(`üì© ${e.data.type}`);
      
      if (e.data.type === 'SANDBOX_READY') {
        logSandbox('Sandbox ready, sending code...');
        
        const code = `function App() {
  return <Button variant="primary">Sandbox Button</Button>;
}`;
        
        preview.contentWindow.postMessage({
          type: 'EXECUTE_CODE',
          payload: { jsxCode: code }
        }, '*');
      } else if (e.data.type === 'RENDER_SUCCESS') {
        logSandbox('‚úÖ Render successful!');
        
        // Check sandbox DOM
        setTimeout(() => {
          try {
            const doc = preview.contentDocument;
            const btn = doc.querySelector('button');
            if (btn) {
              logSandbox(`Button found: ${btn.textContent}`);
              logSandbox(`Button class: ${btn.className}`);
              logSandbox(`Has navds-button: ${btn.classList.contains('navds-button')}`);
              
              const themeDiv = doc.querySelector('.aksel-theme');
              if (themeDiv) {
                logSandbox(`‚úÖ Theme wrapper found: ${themeDiv.className}`);
              } else {
                logSandbox(`‚ùå No Theme wrapper`);
              }
            } else {
              logSandbox('‚ùå No button found in DOM');
            }
          } catch (err) {
            logSandbox(`DOM inspection error: ${err.message}`);
          }
        }, 500);
      } else if (e.data.type === 'RUNTIME_ERROR') {
        logSandbox(`‚ùå ${e.data.payload.message}`);
      } else if (e.data.type === 'CONSOLE_LOG') {
        logSandbox(`Console: ${e.data.payload.args.join(' ')}`);
      }
    });

    testDirect();
  </script>
</body>
</html>
